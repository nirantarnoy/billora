<div class="p-10 max-w-6xl mx-auto">
    <!-- Header with soft blur effect -->
    <header class="mb-12 relative">
        <div class="absolute -top-10 -left-10 w-32 h-32 bg-indigo-100/50 rounded-full blur-3xl"></div>
        <div class="relative z-10">
            <h2 class="text-4xl font-black text-slate-800 tracking-tight">โปรไฟล์และการตั้งค่า</h2>
            <p class="text-slate-500 mt-2 font-medium">จัดการข้อมูลส่วนตัว ข้อมูลองค์กร และตรวจสอบสถานะแพ็กเกจของคุณ</p>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="flex gap-4 mb-10 overflow-x-auto pb-2 no-scrollbar">
        <button onclick="switchTab('personal')" id="tab-personal-btn"
            class="tab-btn px-8 py-3 bg-white text-slate-800 rounded-2xl font-bold border border-slate-100 shadow-sm transition-all flex items-center gap-3 whitespace-nowrap active-tab">
            <i class="fas fa-user-circle text-indigo-500"></i> ข้อมูลส่วนตัว
        </button>
        <button onclick="switchTab('organization')" id="tab-organization-btn"
            class="tab-btn px-8 py-3 bg-white text-slate-500 rounded-2xl font-bold border border-transparent hover:bg-slate-50 transition-all flex items-center gap-3 whitespace-nowrap">
            <i class="fas fa-building text-slate-400"></i> ข้อมูลองค์กร
        </button>
        <button onclick="switchTab('subscription')" id="tab-subscription-btn"
            class="tab-btn px-8 py-3 bg-white text-slate-500 rounded-2xl font-bold border border-transparent hover:bg-slate-50 transition-all flex items-center gap-3 whitespace-nowrap">
            <i class="fas fa-crown text-slate-400"></i> แผนสมาชิก & การใช้งาน
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
        <!-- Left Column: Quick Profile Summary (Always visible or context dependent) -->
        <div class="lg:col-span-4 space-y-8">
            <div
                class="bg-white/60 backdrop-blur-xl rounded-[2.5rem] border border-white shadow-[0_20px_50px_rgba(0,0,0,0.04)] overflow-hidden p-10 text-center relative group">
                <div
                    class="absolute inset-0 bg-gradient-to-b from-indigo-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-28 h-28 rounded-[2rem] bg-gradient-to-tr from-indigo-500 to-purple-400 mx-auto flex items-center justify-center text-white text-4xl font-bold shadow-2xl shadow-indigo-500/20 mb-8 transform group-hover:scale-105 transition-transform duration-500">
                        <%= user.username.charAt(0).toUpperCase() %>
                    </div>
                    <h3 class="text-2xl font-black text-slate-800 mb-2 tracking-tight">
                        <%= user.username %>
                    </h3>
                    <div
                        class="inline-flex items-center px-4 py-1.5 bg-slate-100 text-slate-600 rounded-full text-[10px] font-black uppercase tracking-widest mb-8">
                        <%= user.role==='admin' ? 'Administrator' : (user.role==='owner' ? 'Owner' : 'Member' ) %>
                    </div>

                    <div class="space-y-4 text-left border-t border-slate-100 pt-8 mt-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-store text-slate-300 w-5"></i>
                            <span class="text-sm font-bold text-slate-600">
                                <%= tenant ? tenant.name : 'N/A' %>
                            </span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-id-badge text-slate-300 w-5"></i>
                            <span class="text-xs font-mono text-slate-500">ID: <%= tenant ? (tenant.tenant_code ||
                                    tenant.tenant_id) : 'N/A' %></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Context Info Card (Dynamic based on tab) -->
            <div id="context-info"
                class="bg-indigo-600 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-2xl shadow-indigo-200">
                <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                <div class="relative z-10">
                    <h4 class="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-4">สถานะปัจจุบัน</h4>
                    <p id="context-desc" class="text-lg font-bold leading-relaxed">
                        คุณกำลังใช้งานในระดัับ <%= subscription ? subscription.plan_name : 'Free' %>
                    </p>
                    <div class="mt-8 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-indigo-100 uppercase">ดูแลความปลอดภัยโดย</p>
                            <p class="font-bold">Billora Cloud Secure</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Tab Content -->
        <div class="lg:col-span-8">
            <!-- Tab: Personal -->
            <div id="tab-personal" class="tab-content space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="bg-white rounded-[2.5rem] p-10 border border-slate-100 shadow-sm">
                    <h3 class="text-2xl font-black text-slate-800 mb-8 tracking-tight">แก้ไขข้อมูลส่วนตัว</h3>
                    <form class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Username</label>
                                <input type="text" value="<%= user.username %>" readonly
                                    class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-slate-500 cursor-not-allowed font-bold outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Email</label>
                                <input type="email" value="<%= user.email || '' %>"
                                    class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                            </div>
                        </div>
                        <div class="pt-4 flex gap-4">
                            <button type="submit"
                                class="px-8 py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
                                บันทึกข้อมูล
                            </button>
                            <button type="button"
                                class="px-8 py-4 bg-slate-50 text-slate-600 rounded-2xl font-bold hover:bg-slate-100 transition-all">
                                เปลี่ยนรหัสผ่าน
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab: Organization -->
            <div id="tab-organization"
                class="tab-content hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="bg-white rounded-[2.5rem] p-10 border border-slate-100 shadow-sm">
                    <h3 class="text-2xl font-black text-slate-800 mb-8 tracking-tight">ข้อมูลสถานประกอบการ</h3>
                    <form id="tenantForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">ชื่อสถานประกอบการ
                                    (ไทย)</label>
                                <input type="text" name="company_name"
                                    value="<%= tenant ? (tenant.company_name || tenant.name) : '' %>" required
                                    class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Company Name (EN)</label>
                                <input type="text" name="company_name_en"
                                    value="<%= tenant ? tenant.company_name_en : '' %>"
                                    class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-bold text-slate-700 mb-2">เลขประจำตัวผู้เสียภาษี</label>
                                <input type="text" name="tax_id" value="<%= tenant ? tenant.tax_id : '' %>"
                                    class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">เบอร์โทรศัพท์</label>
                                <input type="text" name="phone" value="<%= tenant ? tenant.phone : '' %>"
                                    class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">ที่อยู่สำนักงาน</label>
                            <textarea name="address" rows="3"
                                class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold"><%= tenant ? tenant.address : '' %></textarea>
                        </div>
                        <div class="pt-4">
                            <button type="submit"
                                class="px-8 py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
                                บันทึกข้อมูลองค์กร
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab: Subscription -->
            <div id="tab-subscription"
                class="tab-content hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <!-- Current Plan Highlighting -->
                <div
                    class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-[3rem] p-10 text-white shadow-2xl relative overflow-hidden">
                    <div class="absolute -right-20 -top-20 w-60 h-60 bg-white/5 rounded-full blur-[80px]"></div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8">
                        <div>
                            <div class="flex items-center gap-3 mb-4">
                                <span
                                    class="px-4 py-1.5 bg-indigo-500 text-white rounded-full text-[10px] font-black uppercase tracking-widest">
                                    Current Plan
                                </span>
                                <span class="text-slate-400 text-xs font-bold">
                                    จนถึง <%= subscription && subscription.end_date ? new
                                        Date(subscription.end_date).toLocaleDateString('th-TH') : 'ไม่มีกำหนด' %>
                                </span>
                            </div>
                            <h2 class="text-5xl font-black tracking-tighter mb-2">
                                <%= subscription ? subscription.plan_name : 'Free Tier' %>
                            </h2>
                            <p class="text-slate-400 font-medium">สัมผัสประสบการณ์การจัดการเอกสารด้วย AI อย่างเต็มรูปแบบ
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Price / Mo
                            </p>
                            <div class="text-3xl font-black">
                                ฿<%= Number(subscription ? subscription.price_monthly : 0).toLocaleString() %>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-8 items-center border-t border-white/10 pt-8">
                        <div class="flex gap-4">
                            <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center text-xl">
                                <i class="fas fa-check text-emerald-400"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold">สิทธิประโยชน์ที่ได้รับ</p>
                                <p class="text-xs text-slate-400">ปลดล็อคฟีเจอร์ AI และ OCR เต็มรูปแบบ</p>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="openPlanModal()"
                                class="px-8 py-4 bg-white text-slate-900 rounded-[1.5rem] font-bold hover:bg-slate-100 transition-all shadow-xl">
                                Upgrade Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Utilization Stats -->
                <div class="bg-white rounded-[2.5rem] p-10 border border-slate-100 shadow-sm">
                    <h4 class="text-xl font-black text-slate-800 mb-8 tracking-tight">สถิติการใช้งานระบบ</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="space-y-4">
                            <div class="flex justify-between text-xs font-bold">
                                <span class="text-slate-400 uppercase tracking-wider">Storage</span>
                                <span class="text-slate-800">85%</span>
                            </div>
                            <div class="w-full h-2 bg-slate-50 rounded-full overflow-hidden">
                                <div class="w-[85%] h-full bg-indigo-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between text-xs font-bold">
                                <span class="text-slate-400 uppercase tracking-wider">AI Audit</span>
                                <span class="text-slate-800">Unlimited</span>
                            </div>
                            <div class="w-full h-2 bg-slate-50 rounded-full overflow-hidden">
                                <div class="w-full h-full bg-emerald-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between text-xs font-bold">
                                <span class="text-slate-400 uppercase tracking-wider">Users</span>
                                <span class="text-slate-800">3 / 5</span>
                            </div>
                            <div class="w-full h-2 bg-slate-50 rounded-full overflow-hidden">
                                <div class="w-[60%] h-full bg-blue-500 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plan Selection Modal -->
<div id="planModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm hidden">
    <div
        class="bg-white w-full max-w-5xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto no-scrollbar border border-white">
        <div class="p-10 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 class="text-3xl font-black text-slate-800 tracking-tight">เลือกแพ็กเกจที่เหมาะสม</h3>
                <p class="text-slate-400 font-medium mt-1">อัปเกรดเพื่อรับฟีเจอร์ที่มากขึ้นและขยายขีดจำกัดขององค์กร</p>
            </div>
            <button onclick="closePlanModal()"
                class="w-12 h-12 rounded-[1.5rem] hover:bg-slate-100 text-slate-400 transition-all border border-slate-100 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="p-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <% (plans || []).forEach(plan=> { %>
                <div
                    class="relative border animate-in zoom-in duration-500 <%= subscription && (subscription.plan_code === plan.plan_code || subscription.plan_id === plan.id) ? 'border-indigo-500 ring-4 ring-indigo-500/10' : 'border-slate-100' %> rounded-[2.5rem] p-8 flex flex-col hover:border-indigo-200 transition-all group">
                    <% if (subscription && (subscription.plan_code===plan.plan_code || subscription.plan_id===plan.id))
                        { %>
                        <div
                            class="absolute -top-4 left-1/2 -translate-x-1/2 px-4 py-1 bg-indigo-500 text-white text-[10px] font-black rounded-full uppercase">
                            Current</div>
                        <% } %>
                            <div class="mb-6">
                                <h4 class="font-black text-slate-800 text-xl tracking-tight">
                                    <%= plan.plan_name %>
                                </h4>
                                <div class="text-4xl font-black text-slate-900 my-4 tracking-tighter">
                                    ฿<%= Number(plan.price_monthly).toLocaleString() %> <span
                                            class="text-sm font-bold text-slate-400 tracking-normal">/mo</span>
                                </div>
                            </div>

                            <ul class="space-y-4 mb-10 flex-1">
                                <li class="flex items-center gap-3 text-sm font-bold text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 text-lg"></i>
                                    <%= plan.max_users %> Users
                                </li>
                                <li class="flex items-center gap-3 text-sm font-bold text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 text-lg"></i>
                                    <%= (plan.max_storage_mb / 1024).toFixed(1) %> GB Storage
                                </li>
                                <li class="flex items-center gap-3 text-sm font-bold text-slate-600">
                                    <i class="fas fa-check-circle text-emerald-500 text-lg"></i>
                                    <%= plan.max_transactions_per_month %> Bills/mo
                                </li>
                            </ul>

                            <% if (subscription && (subscription.plan_code===plan.plan_code ||
                                subscription.plan_id===plan.id)) { %>
                                <button disabled
                                    class="w-full py-4 bg-slate-100 text-slate-400 font-bold rounded-2xl cursor-not-allowed">
                                    Current Active Plan
                                </button>
                                <% } else { %>
                                    <button
                                        onclick="checkoutOmise(<%= plan.id %>, <%= plan.price_monthly %>, '<%= plan.plan_name %>')"
                                        class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-600/20">
                                        เลือกแพ็กเกจนี้
                                    </button>
                                    <% } %>
                </div>
                <% }); %>
        </div>
    </div>
</div>

<!-- Omise Script -->
<script src="https://cdn.omise.co/omise.js"></script>
<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .active-tab {
        background-color: #4f46e5 !important;
        color: white !important;
    }

    .active-tab i {
        color: white !important;
    }

    @keyframes fadeInSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: fadeInSlide 0.5s ease forwards;
    }
</style>

<script>
    function switchTab(tabId) {
        // Hide all contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        // Show target content
        document.getElementById('tab-' + tabId).classList.remove('hidden');

        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active-tab');
            btn.classList.add('text-slate-500');
            btn.classList.remove('text-slate-800');
            // Reset icons
            btn.querySelector('i').classList.add('text-slate-400');
            btn.querySelector('i').classList.remove('text-indigo-500');
        });

        const activeBtn = document.getElementById('tab-' + tabId + '-btn');
        activeBtn.classList.add('active-tab');
        activeBtn.classList.remove('text-slate-500');
        activeBtn.querySelector('i').classList.remove('text-slate-400');

        // Update context info colors
        const contextInfo = document.getElementById('context-info');
        if (tabId === 'organization') {
            contextInfo.className = 'bg-emerald-600 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-2xl shadow-emerald-200';
        } else if (tabId === 'subscription') {
            contextInfo.className = 'bg-slate-800 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-2xl shadow-slate-200';
        } else {
            contextInfo.className = 'bg-indigo-600 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-2xl shadow-indigo-200';
        }
    }

    // Modal Control
    const planModal = document.getElementById('planModal');
    function openPlanModal() { planModal.classList.remove('hidden'); }
    function closePlanModal() { planModal.classList.add('hidden'); }

    // Init Omise
    Omise.setPublicKey('<%= process.env.OMISE_PUBLIC_KEY %>');

    async function checkoutOmise(planId, amount, planName) {
        if (amount === 0) {
            Swal.fire('Coming Soon', 'กรุณาติดต่อผู้ดูแลระบบเพื่อเปลี่ยนเป็นแผนฟรี', 'info');
            return;
        }

        OmiseCard.configure({
            publicKey: '<%= process.env.OMISE_PUBLIC_KEY %>',
            amount: amount * 100,
            currency: 'THB',
            frameLabel: 'Billora Pro',
            submitLabel: 'Pay Now',
            buttonLabel: 'Pay with Omise'
        });

        OmiseCard.open({
            amount: amount * 100,
            currency: 'THB',
            defaultPaymentMethod: 'credit_card',
            otherPaymentMethods: ['promptpay'],
            onCreateTokenSuccess: (nonce) => {
                const data = {
                    planId: planId,
                    amount: amount,
                    paymentMethod: nonce.startsWith('tok') ? 'credit_card' : 'promptpay'
                };
                if (nonce.startsWith('tok')) data.token = nonce;
                else data.source = nonce;
                processPayment(data);
            }
        });
    }

    async function processPayment(data) {
        try {
            Swal.fire({ title: 'กำลังประมวลผล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const response = await fetch('/api/payments/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= _csrf %>' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                if (result.authorize_uri) {
                    window.location.href = result.authorize_uri;
                } else if (result.qr_code_url) {
                    Swal.fire({
                        title: 'Scan to Pay',
                        text: 'กรุณาสแกนเพื่อชำระเงิน',
                        imageUrl: result.qr_code_url,
                        imageWidth: 300, imageHeight: 300,
                        confirmButtonText: 'ชำระเงินแล้ว',
                        footer: '<p class="text-sm text-slate-400 italic">ระบบจะอัปเดตอัตโนมัติภายใน 1-2 นาที</p>'
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire('สำเร็จ', 'ชำระเงินเรียบร้อยแล้ว แผนของคุณมีผลทันที', 'success').then(() => window.location.reload());
                }
            } else {
                Swal.fire('ผิดพลาด', result.message || 'การชำระเงินไม่สำเร็จ', 'error');
            }
        } catch (err) {
            Swal.fire('ผิดพลาด', 'เกิดปัญหาในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        }
    }

    // Tenant Update Logic
    document.getElementById('tenantForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/tenant/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': '<%= _csrf %>' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                Swal.fire('สำเร็จ', 'บันทึกข้อมูลองค์กรเรียบร้อยแล้ว', 'success');
            } else {
                const err = await response.json();
                Swal.fire('ผิดพลาด', err.message || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
            }
        } catch (err) {
            Swal.fire('ผิดพลาด', 'เกิดปัญหาในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        }
    };
</script>