<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billora | จัดการผู้ใช้</title>
    <script src="/js/tailwind.min.js"></script>
    <link href="/css/all.min.css" rel="stylesheet">
    <script src="/js/sweetalert2.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600;700&family=Outfit:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Anuphan', 'Outfit', sans-serif;
            background: #f0f4f8;
            color: #1e293b;
        }

        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .modal-hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        /* Collapsible Sidebar Logic */
        .sidebar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-collapsed {
            transform: translateX(-100%);
        }

        .main-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 288px;
            /* w-72 */
        }

        .main-content-expanded {
            margin-left: 0;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #f43f5e;
            color: white;
            font-size: 10px;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(244, 63, 94, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(244, 63, 94, 0);
            }
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body class="min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="sidebar w-72 min-h-screen bg-white border-r border-slate-200 p-6 flex flex-col fixed left-0 z-40">
            <div class="flex items-center justify-between mb-12">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/50">
                        <i class="fas fa-file-invoice text-white text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold tracking-tight text-slate-800">Billora<span
                            class="text-emerald-500">Pro</span></h1>
                </div>
                <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <nav class="space-y-4 flex-1">
                <% if (user.permissions.dashboard) { %>
                    <a href="/dashboard"
                        class="flex items-center gap-3 p-3 text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl transition-all">
                        <i class="fas fa-th-large"></i> แผงควบคุม
                    </a>
                    <% } %>
                        <% if (user.permissions.bills) { %>
                            <a href="/bills"
                                class="flex items-center gap-3 p-3 text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl transition-all">
                                <i class="fas fa-file-invoice-dollar"></i> ใบเสร็จและใบสำคัญ
                            </a>
                            <% } %>
                                <% if (user.permissions.slips) { %>
                                    <a href="/slips"
                                        class="flex items-center gap-3 p-3 text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl transition-all">
                                        <i class="fas fa-exchange-alt"></i> สลิปการโอนเงิน
                                    </a>
                                    <% } %>
                                        <% if (user.role==='admin' ) { %>
                                            <a href="/channels"
                                                class="flex items-center gap-3 p-3 text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl transition-all">
                                                <i class="fas fa-shopping-cart"></i> ช่องทางออนไลน์
                                            </a>
                                            <a href="/users"
                                                class="flex items-center gap-3 p-3 bg-emerald-600 text-white rounded-xl shadow-lg shadow-emerald-500/30">
                                                <i class="fas fa-users-cog"></i> จัดการผู้ใช้
                                            </a>
                                            <% } %>
            </nav>

            <div class="mt-auto pt-6 border-t border-slate-100 space-y-3">
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-2xl">
                    <div
                        class="w-10 h-10 rounded-full bg-gradient-to-tr from-emerald-500 to-teal-400 flex items-center justify-center text-white font-bold">
                        <%= user.username.charAt(0).toUpperCase() %>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-semibold text-slate-800 truncate">
                            <%= user.username %>
                        </p>
                        <p class="text-xs text-slate-500 capitalize">
                            <%= user.role==='admin' ? 'ผู้ดูแลระบบ' : 'ผู้ใช้งานทั่วไป' %>
                        </p>
                    </div>
                </div>
                <a href="javascript:void(0)" onclick="confirmLogout()"
                    class="flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-xl transition-all font-medium">
                    <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
                </a>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <main id="mainContent" class="main-content flex-1 p-0 min-h-screen">
            <!-- Top Navigation Bar -->
            <div
                class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-100 px-10 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()"
                        class="p-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 transition-all">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="hidden sm:block">
                        <p class="text-sm font-medium text-slate-400">Billora Pro / จัดการผู้ใช้งาน</p>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <!-- Notification Bell -->
                    <div class="relative group cursor-pointer" onclick="showNotifications()">
                        <div
                            class="w-11 h-11 bg-slate-100 rounded-xl flex items-center justify-center text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 transition-all">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div id="notifBadge" class="hidden notification-badge">0</div>
                    </div>
                </div>
            </div>

            <div class="p-10">
                <header class="flex justify-between items-center mb-10">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">จัดการผู้ใช้งานและสิทธิ์</h2>
                        <p class="text-slate-500 text-sm">กำหนดสิทธิ์การเข้าถึงโมดูลต่างๆ ของพนักงาน</p>
                    </div>
                    <button onclick="openModal()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-xl font-semibold transition-all shadow-lg shadow-emerald-600/30">
                        <i class="fas fa-user-plus mr-2"></i> เพิ่มผู้ใช้ใหม่
                    </button>
                </header>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-slate-400 text-sm border-b border-slate-100">
                                <th class="p-6 font-medium">ชื่อผู้ใช้</th>
                                <th class="p-6 font-medium">บทบาท</th>
                                <th class="p-6 font-medium">สิทธิ์การใช้งาน</th>
                                <th class="p-6 font-medium text-right">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <% users.forEach(u=> { %>
                                <tr class="hover:bg-slate-50/50 transition-colors">
                                    <td class="p-6 font-semibold text-slate-700">
                                        <%= u.username %>
                                    </td>
                                    <td class="p-6">
                                        <span
                                            class="px-3 py-1 <%= u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600' %> text-xs rounded-full font-bold uppercase">
                                            <%= u.role %>
                                        </span>
                                    </td>
                                    <td class="p-6">
                                        <div class="flex gap-2">
                                            <% const perms=typeof u.permissions==='string' ? JSON.parse(u.permissions) :
                                                u.permissions; %>
                                                <% if(perms.dashboard) { %><span
                                                        class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Dashboard</span>
                                                    <% } %>
                                                        <% if(perms.bills) { %><span
                                                                class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Bills</span>
                                                            <% } %>
                                                                <% if(perms.slips) { %><span
                                                                        class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Slips</span>
                                                                    <% } %>
                                                                        <% if(perms.users) { %><span
                                                                                class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Users</span>
                                                                            <% } %>
                                        </div>
                                    </td>
                                    <td class="p-6 text-right flex justify-end gap-3">
                                        <button onclick='editUser(this)' data-user='<%- JSON.stringify(u) %>'
                                            class="text-amber-400 hover:text-amber-600 transition-colors">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteUser(<%= u.id %>)"
                                            class="text-red-400 hover:text-red-600 transition-colors">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div id="userModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm modal modal-hidden">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold text-slate-800">เพิ่มผู้ใช้งานใหม่</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="userForm" class="p-8 space-y-6">
                <input type="hidden" id="userId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">ชื่อผู้ใช้</label>
                        <input type="text" id="username" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">รหัสผ่าน</label>
                        <input type="password" id="password"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"
                            placeholder="เว้นว่างไว้หากไม่ต้องการเปลี่ยน">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">บทบาท</label>
                        <select id="role"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                            <option value="user">User (ผู้ใช้งานทั่วไป)</option>
                            <option value="admin">Admin (ผู้ดูแลระบบ)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-4">กำหนดสิทธิ์การเข้าถึงโมดูล</label>
                    <div class="space-y-3 p-4 bg-slate-50 rounded-2xl">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="perm_dashboard" checked
                                class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                            <span class="text-sm font-medium text-slate-700">เข้าถึงแผงควบคุม (Dashboard)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="perm_bills" checked
                                class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                            <span class="text-sm font-medium text-slate-700">จัดการใบเสร็จ (Bills & Receipts)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="perm_slips" checked
                                class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                            <span class="text-sm font-medium text-slate-700">จัดการสลิป (Payment Slips)</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="perm_users"
                                class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                            <span class="text-sm font-medium text-slate-700">จัดการผู้ใช้ (User Management)</span>
                        </label>
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-emerald-600/30">
                    บันทึกข้อมูลผู้ใช้
                </button>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('userModal');
        const userForm = document.getElementById('userForm');
        const modalTitle = document.getElementById('modalTitle');
        const userIdInput = document.getElementById('userId');

        function openModal() {
            modalTitle.textContent = 'เพิ่มผู้ใช้งานใหม่';
            userForm.reset();
            userIdInput.value = '';
            document.getElementById('password').required = true;
            modal.classList.remove('modal-hidden');
        }

        function editUser(btn) {
            const user = JSON.parse(btn.getAttribute('data-user'));
            modalTitle.textContent = 'แก้ไขข้อมูลผู้ใช้: ' + user.username;
            userIdInput.value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('password').value = '';
            document.getElementById('password').required = false;
            document.getElementById('role').value = user.role;

            const perms = typeof user.permissions === 'string' ? JSON.parse(user.permissions) : user.permissions;
            document.getElementById('perm_dashboard').checked = perms.dashboard;
            document.getElementById('perm_bills').checked = perms.bills;
            document.getElementById('perm_slips').checked = perms.slips;
            document.getElementById('perm_users').checked = perms.users;

            modal.classList.remove('modal-hidden');
        }

        function closeModal() { modal.classList.add('modal-hidden'); }

        userForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = userIdInput.value;
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                permissions: {
                    dashboard: document.getElementById('perm_dashboard').checked,
                    bills: document.getElementById('perm_bills').checked,
                    slips: document.getElementById('perm_slips').checked,
                    users: document.getElementById('perm_users').checked,
                }
            };

            const url = id ? `/api/users/${id}` : '/api/users';
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) { window.location.reload(); }
            else {
                const err = await res.json();
                alert(err.error || 'Error saving user');
            }
        };

        async function deleteUser(id) {
            if (!confirm('ยืนยันการลบผู้ใช้?')) return;
            const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
            if (res.ok) { window.location.reload(); }
            else {
                const err = await res.json();
                alert(err.error || 'Error deleting user');
            }
        }

        function confirmLogout() {
            Swal.fire({
                title: 'ยืนยันการออกจากระบบ?',
                text: "คุณต้องการออกจากเซสชันปัจจุบันหรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#f43f5e',
                confirmButtonText: 'ใช่, ออกจากระบบ',
                cancelButtonText: 'ยกเลิก',
                background: '#fff',
                borderRadius: '1.5rem',
                customClass: {
                    title: 'font-bold text-slate-800',
                    popup: 'rounded-3xl'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/logout';
                }
            })
        }

        // Sidebar & UI Logic
        let isSidebarCollapsed = false;
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            isSidebarCollapsed = !isSidebarCollapsed;

            if (isSidebarCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.add('main-content-expanded');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                mainContent.classList.remove('main-content-expanded');
            }
        }

        // Notification System
        let notifications = [];
        const notifBadge = document.getElementById('notifBadge');

        function updateNotifUI() {
            if (notifications.length > 0) {
                notifBadge.textContent = notifications.length;
                notifBadge.classList.remove('hidden');
            } else {
                notifBadge.classList.add('hidden');
            }
        }

        function showNotifications() {
            if (notifications.length === 0) {
                Swal.fire({
                    title: 'ไม่มีการแจ้งเตือน',
                    text: 'เอกสารทั้งหมดได้รับการประมวลผลแล้ว',
                    icon: 'info',
                    confirmButtonColor: '#10b981',
                    customClass: { popup: 'rounded-3xl' }
                });
                return;
            }

            const listHtml = notifications.map((n, i) => `
                <div class="flex items-center gap-4 p-4 ${i !== notifications.length - 1 ? 'border-b border-slate-100' : ''} text-left">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                        <i class="fas ${n.type === 'BANK_SLIP' ? 'fa-exchange-alt' : 'fa-file-invoice-dollar'}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-bold text-slate-800">${n.type === 'BANK_SLIP' ? 'สลิปการโอน' : 'ใบเสร็จ'}</p>
                        <p class="text-xs text-slate-500">ยอดเงิน: ฿${Number(n.amount).toLocaleString()}</p>
                    </div>
                    <span class="text-[10px] text-slate-400 font-mono">${new Date().toLocaleTimeString()}</span>
                </div>
            `).join('');

            Swal.fire({
                title: 'รายการแจ้งเตือนล่าสุด',
                html: `<div class="mt-4 max-h-80 overflow-y-auto rounded-2xl bg-slate-50 border border-slate-100">${listHtml}</div>`,
                showCancelButton: true,
                confirmButtonText: 'รีเฟรชหน้าเว็บ',
                cancelButtonText: 'ล้างทั้งหมด',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#f43f5e',
                customClass: { popup: 'rounded-3xl' }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.reload();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    notifications = [];
                    updateNotifUI();
                }
            });
        }

        // Socket logic integration
        const socket = io();
        socket.on('new_upload', (data) => {
            if (data.results) {
                notifications = [...data.results, ...notifications].slice(0, 10);
                updateNotifUI();
            }

            const Toast = Swal.mixin({
                toast: true, position: 'top-end',
                showConfirmButton: false, timer: 5000, timerProgressBar: true
            });

            Toast.fire({
                icon: 'success',
                title: `พบรายการใหม่ ${data.count} รายการ`,
                text: 'คลิกที่รูปกระดิ่งเพื่อดูรายละเอียด'
            });
        });
    </script>
</body>

</html>