<div class="p-10">
    <header class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-3xl font-bold text-slate-800">จัดการผู้ใช้งานและสิทธิ์</h2>
            <p class="text-slate-500 text-sm">กำหนดสิทธิ์การเข้าถึงโมดูลต่างๆ ของพนักงาน</p>
        </div>
        <button onclick="openModal()"
            class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-xl font-semibold transition-all shadow-lg shadow-emerald-600/30">
            <i class="fas fa-user-plus mr-2"></i> เพิ่มผู้ใช้ใหม่
        </button>
    </header>

    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="text-left text-slate-400 text-sm border-b border-slate-100">
                    <th class="p-6 font-medium">ชื่อผู้ใช้</th>
                    <th class="p-6 font-medium">บทบาท</th>
                    <th class="p-6 font-medium">สิทธิ์การใช้งาน</th>
                    <th class="p-6 font-medium text-right">จัดการ</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
                <% users.forEach(u=> { %>
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="p-6 font-semibold text-slate-700">
                            <%= u.username %>
                        </td>
                        <td class="p-6">
                            <span
                                class="px-3 py-1 <%= u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600' %> text-xs rounded-full font-bold uppercase">
                                <%= u.role %>
                            </span>
                        </td>
                        <td class="p-6">
                            <div class="flex gap-2">
                                <% let perms=typeof u.permissions==='string' ? JSON.parse(u.permissions) :
                                    u.permissions; perms=perms || {}; %>
                                    <% if(perms.dashboard) { %><span
                                            class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Dashboard</span>
                                        <% } %>
                                            <% if(perms.bills) { %><span
                                                    class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Bills</span>
                                                <% } %>
                                                    <% if(perms.slips) { %><span
                                                            class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Slips</span>
                                                        <% } %>
                                                            <% if(perms.users) { %><span
                                                                    class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">Users</span>
                                                                <% } %>
                            </div>
                        </td>
                        <td class="p-6 text-right flex justify-end gap-3">
                            <button onclick='editUser(this)' data-user='<%= JSON.stringify(u) %>'
                                class="text-amber-400 hover:text-amber-600 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser(<%= u.id %>)"
                                class="text-red-400 hover:text-red-600 transition-colors">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                    <% }) %>
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div id="userModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm modal modal-hidden">
    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <h3 id="modalTitle" class="text-xl font-bold text-slate-800">เพิ่มผู้ใช้งานใหม่</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i
                    class="fas fa-times"></i></button>
        </div>
        <form id="userForm" class="p-8 space-y-6">
            <input type="hidden" id="userId">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">ชื่อผู้ใช้</label>
                    <input type="text" id="username" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">รหัสผ่าน</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"
                        placeholder="เว้นว่างไว้หากไม่ต้องการเปลี่ยน">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">บทบาท</label>
                    <select id="role"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                        <option value="user">User (ผู้ใช้งานทั่วไป)</option>
                        <option value="admin">Admin (ผู้ดูแลระบบ)</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-4">กำหนดสิทธิ์การเข้าถึงโมดูล</label>
                <div class="space-y-3 p-4 bg-slate-50 rounded-2xl">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="perm_dashboard" checked
                            class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                        <span class="text-sm font-medium text-slate-700">เข้าถึงแผงควบคุม (Dashboard)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="perm_bills" checked
                            class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                        <span class="text-sm font-medium text-slate-700">จัดการใบเสร็จ (Bills & Receipts)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="perm_slips" checked
                            class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                        <span class="text-sm font-medium text-slate-700">จัดการสลิป (Payment Slips)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="perm_users"
                            class="w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500">
                        <span class="text-sm font-medium text-slate-700">จัดการผู้ใช้ (User Management)</span>
                    </label>
                </div>
            </div>

            <button type="submit"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-emerald-600/30">
                บันทึกข้อมูลผู้ใช้
            </button>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('userModal');
    const userForm = document.getElementById('userForm');
    const modalTitle = document.getElementById('modalTitle');
    const userIdInput = document.getElementById('userId');

    function openModal() {
        modalTitle.textContent = 'เพิ่มผู้ใช้งานใหม่';
        userForm.reset();
        userIdInput.value = '';
        document.getElementById('password').required = true;
        modal.classList.remove('modal-hidden');
    }

    function editUser(btn) {
        const user = JSON.parse(btn.getAttribute('data-user'));
        modalTitle.textContent = 'แก้ไขข้อมูลผู้ใช้: ' + user.username;
        userIdInput.value = user.id;
        document.getElementById('username').value = user.username;
        document.getElementById('password').value = '';
        document.getElementById('password').required = false;
        document.getElementById('role').value = user.role;

        const perms = typeof user.permissions === 'string' ? JSON.parse(user.permissions) : user.permissions;
        document.getElementById('perm_dashboard').checked = perms.dashboard;
        document.getElementById('perm_bills').checked = perms.bills;
        document.getElementById('perm_slips').checked = perms.slips;
        document.getElementById('perm_users').checked = perms.users;

        modal.classList.remove('modal-hidden');
    }

    function closeModal() { modal.classList.add('modal-hidden'); }

    userForm.onsubmit = async (e) => {
        e.preventDefault();
        const id = userIdInput.value;
        const data = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            role: document.getElementById('role').value,
            permissions: {
                dashboard: document.getElementById('perm_dashboard').checked,
                bills: document.getElementById('perm_bills').checked,
                slips: document.getElementById('perm_slips').checked,
                users: document.getElementById('perm_users').checked,
            }
        };

        const url = id ? `/api/users/${id}` : '/api/users';
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrfToken()
            },
            body: JSON.stringify(data)
        });

        if (res.ok) { window.location.reload(); }
        else {
            const err = await res.json();
            alert(err.error || 'Error saving user');
        }
    };

    async function deleteUser(id) {
        if (!confirm('ยืนยันการลบผู้ใช้?')) return;
        const res = await fetch(`/api/users/${id}`, {
            method: 'DELETE',
            headers: { 'X-CSRF-TOKEN': getCsrfToken() }
        });
        if (res.ok) { window.location.reload(); }
        else {
            const err = await res.json();
            alert(err.error || 'Error deleting user');
        }
    }
</script>