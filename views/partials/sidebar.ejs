<aside id="sidebar"
    class="sidebar w-72 h-screen bg-white border-r border-slate-200 p-6 flex flex-col fixed left-0 z-40">
    <div class="flex items-center justify-between mb-12">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/50">
                <i class="fas fa-file-invoice text-white text-xl"></i>
            </div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-800">GoodOper<span
                    class="text-emerald-500">Pro</span></h1>
        </div>
        <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-slate-600">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <nav class="space-y-6 flex-1 overflow-y-auto no-scrollbar">
        <!-- OCR & Accounting Module -->
        <% if (typeof user !=='undefined' && user && (user.permissions?.ocr_basic || user.permissions?.dashboard ||
            user.role==='admin' || user.role==='owner' )) { %>
            <div class="space-y-1">
                <p class="px-3 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest opacity-60">OCR &
                    Accounting</p>
                <a href="/dashboard"
                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'dashboard') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                    <i class="fas fa-th-large w-5"></i> แผงควบคุม
                </a>
                <a href="/bills"
                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'bills') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                    <i class="fas fa-file-invoice-dollar w-5"></i> ใบเสร็จและรายจ่าย
                </a>
                <a href="/slips"
                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'slips') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                    <i class="fas fa-exchange-alt w-5"></i> สลิปโอนเงิน
                </a>
                <a href="/reconciliation"
                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'reconciliation') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                    <i class="fas fa-chart-line w-5"></i> เปรียบเทียบยอดขาย
                </a>
            </div>
            <% } %>

                <!-- Marketplace Module -->
                <% if (typeof user !=='undefined' && user && (user.permissions?.multichannel || user.role==='admin' ||
                    user.role==='owner' )) { %>
                    <div class="space-y-1">
                        <p class="px-3 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest opacity-60">
                            Marketplace</p>
                        <a href="/channels"
                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'channels') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                            <i class="fas fa-plug w-5"></i> เชื่อมต่อร้านค้า
                        </a>
                        <a href="/orders"
                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'orders') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                            <i class="fas fa-shopping-cart w-5"></i> ออเดอร์ออนไลน์
                        </a>
                        <a href="/sync-history"
                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'sync-history') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                            <i class="fas fa-sync-alt w-5"></i> ประวัติการซิงค์
                        </a>
                        <a href="/fee-report"
                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'fee-report') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                            <i class="fas fa-file-invoice-dollar w-5"></i> รายงานค่าธรรมเนียม
                        </a>
                    </div>
                    <% } %>

                        <!-- Fulfillment Module -->
                        <% if (typeof user !=='undefined' && user && (user.permissions?.fulfillment ||
                            user.role==='admin' || user.role==='owner' )) { %>
                            <div class="space-y-1">
                                <p
                                    class="px-3 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest opacity-60">
                                    Fulfillment</p>
                                <a href="/fulfillment/warehouses"
                                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'inventory' && (typeof title !== 'undefined' && title && title.includes('คลัง'))) ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                    <i class="fas fa-warehouse w-5"></i> คลังสินค้า
                                </a>
                                <a href="/fulfillment/products"
                                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'inventory' && (typeof title !== 'undefined' && title && title.includes('สินค้า') && !title.includes('คลัง'))) ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                    <i class="fas fa-box w-5"></i> จัดการสินค้า
                                </a>
                                <a href="/inventory/balances"
                                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'inventory-balance') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                    <i class="fas fa-boxes w-5"></i> ยอดคงเหลือ & สต็อก
                                </a>
                                <a href="/inventory/transactions"
                                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'inventory-transactions') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                    <i class="fas fa-history w-5"></i> ความเคลื่อนไหว (Stock Card)
                                </a>
                                <a href="/inventory/purchase-plan"
                                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'inventory-purchase-plan') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                    <i class="fas fa-clipboard-list w-5"></i> แผนการสั่งซื้อ (Reorder)
                                </a>
                                <a href="#"
                                    class="flex items-center gap-3 p-3 text-slate-300 cursor-not-allowed rounded-xl transition-all">
                                    <i class="fas fa-truck w-5"></i> การจัดส่ง (Soon)
                                </a>
                            </div>
                            <% } %>

                                <!-- Admin Control -->
                                <% if (typeof user !=='undefined' && user && (user.role==='admin' || user.role==='owner'
                                    )) { %>
                                    <div class="space-y-2 border-t border-slate-100 pt-4">
                                        <p class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                            Admin Control</p>
                                        <a href="/history"
                                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'history') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                            <i class="fas fa-history"></i> ประวัติการสแกน
                                        </a>
                                        <a href="/users"
                                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'users') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                            <i class="fas fa-users-cog"></i> จัดการผู้ใช้
                                        </a>
                                        <a href="/backup/schedules"
                                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'backup') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                            <i class="fas fa-clock"></i> Auto Backup
                                        </a>
                                        <a href="/admin/tenants"
                                            class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'admin-tenants') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                            <i class="fas fa-building"></i> จัดการ Tenant
                                        </a>
                                        <% if (typeof user !=='undefined' && user && user.tenant_id===1) { %>
                                            <a href="/admin/plans"
                                                class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'admin-plans') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                                <i class="fas fa-boxes"></i> จัดการแพ็กเกจ & Module
                                            </a>
                                            <% } %>
                                                <a href="/admin/logs"
                                                    class="flex items-center gap-3 p-3 <%= (typeof active !== 'undefined' && active === 'logs') ? 'sidebar-active' : 'text-slate-500 hover:bg-emerald-50 hover:text-emerald-600' %> rounded-xl transition-all">
                                                    <i class="fas fa-clipboard-list"></i> บันทึกกิจกรรม
                                                </a>
                                    </div>
                                    <% } %>
    </nav>

    <!-- Hidden Debug Button -->
    <% if (typeof user !=='undefined' && user && (user.role==='admin' || user.role==='owner' )) { %>
        <div class="mt-auto pt-4 border-t border-slate-50 opacity-0 hover:opacity-100 transition-opacity">
            <button onclick="handleClearData()"
                class="w-full text-[10px] text-slate-300 hover:text-red-400 text-left px-3 py-1">
                <i class="fas fa-trash-alt mr-2"></i> Clear Test Data
            </button>
            <button onclick="viewPdpaConsent()"
                class="w-full text-[10px] text-slate-300 hover:text-emerald-400 text-left px-3 py-1">
                <i class="fas fa-fingerprint mr-2"></i> View PDPA Consent
            </button>
        </div>
        <% } %>
</aside>

<!-- Secret Debug Button Script -->
<script>
    async function handleClearData() {
        const { value: confirm } = await Swal.fire({
            title: 'ยืนยันการเคลียร์ข้อมูล?',
            text: "ข้อมูล Bills, Bill Items และ Slips ทั้งหมดจะถูกลบถาวร!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ลบข้อมูลทั้งหมด',
            cancelButtonText: 'ยกเลิก',
            footer: '<small class="text-slate-400">เฉพาะ Admin เท่านั้น</small>'
        });

        if (confirm) {
            try {
                const response = await fetch('/api/debug/clear-data', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': '<%= (typeof _csrf !== "undefined") ? _csrf : "" %>'
                    }
                });
                const result = await response.json();
                if (result.success) {
                    Swal.fire('สำเร็จ!', result.message, 'success').then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire('ผิดพลาด', result.message || 'ไม่สามารถลบข้อมูลได้', 'error');
                }
            } catch (err) {
                Swal.fire('ผิดพลาด', 'เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
            }
        }
    }

    async function viewPdpaConsent() {
        try {
            const consent = localStorage.getItem('pdpa_consent_v1');
            const response = await fetch('/api/pdpa/stats');
            const stats = await response.json();

            Swal.fire({
                title: 'PDPA Consent Overview',
                html: `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 text-center">
                                <p class="text-[10px] uppercase font-bold text-emerald-600 mb-1">Your Device</p>
                                <p class="text-xs font-mono ${consent ? 'text-emerald-700' : 'text-slate-400'}">${consent ? 'ACCEPTED' : 'PENDING'}</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-center">
                                <p class="text-[10px] uppercase font-bold text-blue-600 mb-1">Total Testers</p>
                                <p class="text-xl font-bold text-blue-800">${stats.count || 0}</p>
                            </div>
                        </div>
                        <div class="text-left font-mono text-[10px] bg-slate-50 p-3 rounded-xl border border-slate-200 overflow-y-auto max-h-40">
                             <p class="text-slate-400 mb-2">// Server JSON Log (Last 5)</p>
                             ${stats.history ? stats.history.slice(-5).reverse().map(h => `
                                <div class="mb-2 pb-2 border-b border-slate-100 last:border-0 text-slate-500">
                                    [${new Date(h.timestamp).toLocaleString('th-TH')}]<br>
                                    IP: ${h.ip}
                                </div>
                             `).join('') : 'No history yet'}
                        </div>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'รับทราบ',
                confirmButtonColor: '#10b981',
                showDenyButton: true,
                denyButtonText: 'ล้าง Log ทั้งหมด',
                denyButtonColor: '#f43f5e',
                customClass: { popup: 'rounded-3xl' }
            }).then((result) => {
                if (result.isDenied) {
                    handleClearPdpaLogs();
                }
            });
        } catch (err) {
            Swal.fire('Error', 'ไม่สามารถดึงข้อมูลได้', 'error');
        }
    }

    async function handleClearPdpaLogs() {
        const { value: confirm } = await Swal.fire({
            title: 'ยืนยันการล้างประวัติ?',
            text: "ข้อมูลการยอมรับ PDPA ทั้งหมดใน Server จะถูกล้างเป็นศูนย์!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f43f5e',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'ยืนยัน ล้างข้อมูล',
            cancelButtonText: 'ยกเลิก',
            customClass: { popup: 'rounded-3xl' }
        });

        if (confirm) {
            try {
                const response = await fetch('/api/pdpa/stats', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-Token': '<%= (typeof _csrf !== "undefined") ? _csrf : "" %>'
                    }
                });
                const result = await response.json();
                if (result.success) {
                    Swal.fire('สำเร็จ!', result.message, 'success');
                }
            } catch (err) {
                Swal.fire('ผิดพลาด', 'ไม่สามารถล้างข้อมูลได้', 'error');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const activeItem = document.querySelector('.sidebar-active');
        if (activeItem) {
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
</script>