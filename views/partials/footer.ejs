<script>
    // Sidebar & UI Logic
    let isSidebarCollapsed = false;
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        if (!sidebar || !mainContent) return;
        isSidebarCollapsed = !isSidebarCollapsed;

        if (isSidebarCollapsed) {
            sidebar.classList.add('sidebar-collapsed');
            mainContent.classList.add('main-content-expanded');
        } else {
            sidebar.classList.remove('sidebar-collapsed');
            mainContent.classList.remove('main-content-expanded');
        }
    }

    function confirmLogout() {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            customClass: { popup: 'rounded-3xl' }
        }).then((result) => {
            if (result.isConfirmed) window.location.href = '/logout';
        });
    }

    let lastNotifType = 'BANK_SLIP'; // Default

    function showNotifications() {
        const badge = document.getElementById('notifBadge');
        const count = badge ? parseInt(badge.textContent) : 0;

        if (count > 0) {
            goToNotifPage(count);
        } else {
            Swal.fire({
                title: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
                text: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà',
                icon: 'info',
                confirmButtonColor: '#10b981',
                customClass: { popup: 'rounded-3xl' }
            });
        }
    }

    function goToNotifPage(count = null) {
        if (!count) {
            const badge = document.getElementById('notifBadge');
            count = badge ? parseInt(badge.textContent) : 0;
        }

        // Clear count when going to page
        sessionStorage.removeItem('notifCount');

        const path = (lastNotifType === 'BANK_SLIP') ? '/slips' : '/bills';
        const url = count > 0 ? `${path}?newCount=${count}` : path;
        window.location.href = url;
    }

    function updateBadge(newItemsCount) {
        const badge = document.getElementById('notifBadge');
        if (!badge) return;

        let currentCount = parseInt(sessionStorage.getItem('notifCount')) || 0;
        currentCount += newItemsCount;

        sessionStorage.setItem('notifCount', currentCount);
        badge.textContent = currentCount;

        if (currentCount > 0) {
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Restore badge from storage
        const savedCount = parseInt(sessionStorage.getItem('notifCount')) || 0;
        if (savedCount > 0) {
            const badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = savedCount;
                badge.classList.remove('hidden');
            }
        }
        // Handle redirect alert from query param
        const urlParams = new URLSearchParams(window.location.search);
        const newCount = urlParams.get('newCount');

        if (newCount) {
            const mainContent = document.querySelector('.p-10');
            if (mainContent) {
                // Create a horizontal banner alert
                const alertDiv = document.createElement('div');
                alertDiv.id = 'pageBannerAlert';
                alertDiv.className = 'mb-6 transform -translate-y-4 opacity-0 transition-all duration-500 ease-out';
                alertDiv.innerHTML = `
                    <div class="bg-emerald-600 text-white px-6 py-4 rounded-3xl shadow-lg flex items-center justify-between border border-emerald-400/30 backdrop-blur-md">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-double text-lg"></i>
                            </div>
                            <div>
                                <p class="font-bold text-lg">‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà!</p>
                                <p class="text-sm opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="font-bold underline">${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span> ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</p>
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-white/60 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                `;

                // Insert after the header (first child of .p-10 is usually header)
                const header = mainContent.querySelector('header');
                if (header) {
                    header.after(alertDiv);
                } else {
                    mainContent.prepend(alertDiv);
                }

                // Animate in
                setTimeout(() => {
                    alertDiv.classList.remove('-translate-y-4', 'opacity-0');
                    alertDiv.classList.add('translate-y-0', 'opacity-100');
                }, 100);

                // Auto hide after 8 seconds
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.classList.add('-translate-y-4', 'opacity-0');
                        setTimeout(() => alertDiv.remove(), 500);
                    }

                    // Clean up URL without refreshing
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }, 8000);
            }
        }
    });

    function openChangePasswordModal() {
        Swal.fire({
            title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
            html: `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label>
                        <input type="password" id="currentPassword" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                        <input type="password" id="newPassword" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            customClass: { popup: 'rounded-3xl' },
            preConfirm: () => {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return false;
                }

                if (newPassword.length < 6) {
                    Swal.showValidationMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    Swal.showValidationMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                    return false;
                }

                return fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                            });
                        }
                        return response.json();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(error.message);
                    });
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    confirmButtonColor: '#10b981',
                    customClass: { popup: 'rounded-3xl' }
                });
            }
        });
    }
    // Socket.io Notification Logic
    const socket = io();

    socket.on('connect', () => {
        console.log('‚úÖ Connected to Notification Server');
    });

    socket.on('connect_error', (error) => {
        console.error('‚ùå Socket Connection Error:', error);
    });

    socket.on('new_upload', (data) => {
        console.log('üì¢ New Notification received:', data);

        // Track the type of the first result to know where to redirect from the bell
        const firstResult = data.results && data.results[0];
        if (firstResult) {
            lastNotifType = firstResult.type;
        }

        updateBadge(data.count || 1);

        // Show Toast Notification with explicit View button
        Swal.fire({
            title: '‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà!',
            text: `‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ${data.count || 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
            icon: 'info',
            toast: true,
            position: 'top-end',
            showConfirmButton: true,
            confirmButtonText: '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
            confirmButtonColor: '#10b981',
            timer: 10000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.style.cursor = 'pointer';
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            },
            customClass: {
                popup: 'rounded-2xl shadow-xl'
            }
        }).then((result) => {
            // ONLY redirect if they explicitly clicked the confirm button
            if (result.isConfirmed) {
                if (lastNotifType === 'BANK_SLIP') {
                    window.location.href = '/slips';
                } else {
                    window.location.href = '/bills';
                }
            }
        });
    });

    // Handle user-specific upload completion
    const currentUserId = '<%= typeof user !== "undefined" ? user.id : "" %>';
    if (currentUserId) {
        socket.on(`upload_complete_${currentUserId}`, (data) => {
            console.log('‚úÖ Job completed for user:', data);
            if (data.success && window.SHOULD_RELOAD_ON_UPLOAD) {
                // Delay a bit to let the user see the success toast from new_upload if any
                setTimeout(() => window.location.reload(), 1000);
            }
        });
    }
</script>


<!-- Global Bell Notification Alert -->
<div id="bellNotif"
    class="fixed top-20 right-6 z-[100] transform translate-x-full opacity-0 transition-all duration-500 ease-in-out hidden">
    <div onclick="goToNotifPage()"
        class="cursor-pointer bg-emerald-600 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 border border-emerald-400/50 backdrop-blur-md hover:bg-emerald-700 transition-colors">
        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-bell text-lg"></i>
        </div>
        <div>
            <p class="font-bold">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
            <p class="text-sm opacity-90" id="bellNotifText">‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π)</p>
        </div>
        <div class="ml-2 w-6 h-6 flex items-center justify-center rounded-full bg-white/10">
            <i class="fas fa-chevron-right text-[10px]"></i>
        </div>
    </div>
</div>
</body>

</html>