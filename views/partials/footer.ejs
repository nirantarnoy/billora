<script>
    // Sidebar & UI Logic
    let isSidebarCollapsed = false;
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        if (!sidebar || !mainContent) return;
        isSidebarCollapsed = !isSidebarCollapsed;

        if (isSidebarCollapsed) {
            sidebar.classList.add('sidebar-collapsed');
            mainContent.classList.add('main-content-expanded');
        } else {
            sidebar.classList.remove('sidebar-collapsed');
            mainContent.classList.remove('main-content-expanded');
        }
    }

    function confirmLogout() {
        Swal.fire({
            title: 'ยืนยันการออกจากระบบ?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'ตกลง',
            cancelButtonText: 'ยกเลิก',
            customClass: { popup: 'rounded-3xl' }
        }).then((result) => {
            if (result.isConfirmed) window.location.href = '/logout';
        });
    }

    function showNotifications() {
        Swal.fire({
            title: 'การแจ้งเตือน',
            text: 'ยังไม่มีการแจ้งเตือนใหม่',
            icon: 'info',
            confirmButtonColor: '#10b981',
            customClass: { popup: 'rounded-3xl' }
        });
    }

    function openChangePasswordModal() {
        Swal.fire({
            title: 'เปลี่ยนรหัสผ่าน',
            html: `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">รหัสผ่านเดิม</label>
                        <input type="password" id="currentPassword" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="กรอกรหัสผ่านเดิม">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">รหัสผ่านใหม่</label>
                        <input type="password" id="newPassword" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="กรอกรหัสผ่านใหม่">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ยืนยันรหัสผ่านใหม่</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="กรอกรหัสผ่านใหม่อีกครั้ง">
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'เปลี่ยนรหัสผ่าน',
            cancelButtonText: 'ยกเลิก',
            customClass: { popup: 'rounded-3xl' },
            preConfirm: () => {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    Swal.showValidationMessage('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return false;
                }

                if (newPassword.length < 6) {
                    Swal.showValidationMessage('รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร');
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    Swal.showValidationMessage('รหัสผ่านใหม่ไม่ตรงกัน');
                    return false;
                }

                return fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'เกิดข้อผิดพลาด');
                            });
                        }
                        return response.json();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(error.message);
                    });
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'สำเร็จ!',
                    text: 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว',
                    icon: 'success',
                    confirmButtonColor: '#10b981',
                    customClass: { popup: 'rounded-3xl' }
                });
            }
        });
    }
    // Socket.io Notification Logic
    const socket = io();
    socket.on('new_upload', (data) => {
        const badge = document.getElementById('notifBadge');
        if (badge) {
            let currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + (data.count || 1);
            badge.classList.remove('hidden');
        }

        // Show Toast Notification
        Swal.fire({
            title: 'พบเอกสารใหม่!',
            text: `มีการแนบไฟล์เข้ามาใหม่ ${data.count || 1} รายการ`,
            icon: 'info',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            },
            customClass: {
                popup: 'rounded-2xl'
            }
        });
    });
</script>
</body>

</html>