<div class="p-8 max-w-4xl mx-auto">
    <!-- Back Button -->
    <a href="/inventory/balances"
        class="inline-flex items-center gap-2 text-slate-400 hover:text-slate-600 mb-6 transition-colors">
        <i class="fas fa-arrow-left"></i> กลับไปหน้ายอดคงเหลือ
    </a>

    <div class="bg-white rounded-[32px] shadow-lg border border-slate-100 overflow-hidden">
        <div class="p-8 border-b border-slate-100 bg-slate-50/50">
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                <% if (type==='ISSUE' ) { %>
                    <span class="w-10 h-10 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center"><i
                            class="fas fa-minus"></i></span>
                    <% } else if (type==='RETURN' ) { %>
                        <span class="w-10 h-10 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center"><i
                                class="fas fa-undo"></i></span>
                        <% } else { %>
                            <span
                                class="w-10 h-10 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center"><i
                                    class="fas fa-sliders-h"></i></span>
                            <% } %>
                                <%= title %>
            </h2>
        </div>

        <form action="/inventory/transaction" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="type" value="<%= type %>">
            <input type="hidden" name="_csrf" value="<%= _csrf %>">

            <% if (type==='ADJUSTMENT' ) { %>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <label
                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">รูปแบบการปรับยอด</label>
                    <div class="flex gap-4">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="adjust_mode" value="add" class="peer sr-only" checked>
                            <div
                                class="text-center py-3 rounded-xl border-2 border-slate-200 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 transition-all">
                                <i class="fas fa-plus mb-1 block"></i> เพิ่มยอด
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="adjust_mode" value="subtract" class="peer sr-only">
                            <div
                                class="text-center py-3 rounded-xl border-2 border-slate-200 peer-checked:border-rose-500 peer-checked:bg-rose-50 peer-checked:text-rose-700 transition-all">
                                <i class="fas fa-minus mb-1 block"></i> ลด/ตัดยอด
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="adjust_mode" value="set" class="peer sr-only">
                            <div
                                class="text-center py-3 rounded-xl border-2 border-slate-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition-all">
                                <i class="fas fa-equals mb-1 block"></i> ตั้งค่ายอดใหม่
                            </div>
                        </label>
                    </div>
                </div>
                <% } %>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Product -->
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">สินค้า
                                <span class="text-red-500">*</span></label>
                            <select name="product_id" required
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                                <option value="">-- เลือกสินค้า --</option>
                                <% products.forEach(p=> { %>
                                    <option value="<%= p.id %>">
                                        <%= p.name %> (<%= p.sku %>)
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <!-- Warehouse -->
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">คลังสินค้า
                                <span class="text-red-500">*</span></label>
                            <select name="warehouse_id" id="warehouseSelect" required
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                                <option value="">-- เลือกคลัง --</option>
                                <% warehouses.forEach(w=> { %>
                                    <option value="<%= w.id %>">
                                        <%= w.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>

                        <!-- Location -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ตำแหน่ง
                                (Location)</label>
                            <select name="location_id" id="locationSelect"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500"
                                disabled>
                                <option value="">-- ไม่ระบุ / พื้นที่ทั่วไป --</option>
                            </select>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6"></div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Lot No -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Lot
                                No.</label>
                            <input type="text" name="lot_no" placeholder="Optional"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                        </div>

                        <!-- Mfg Date -->
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่ผลิต
                                (MFG)</label>
                            <input type="date" name="mfg_date"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                        </div>

                        <!-- Exp Date -->
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันหมดอายุ
                                (EXP)</label>
                            <input type="date" name="exp_date"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6"></div>

                    <!-- Quantity -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">จำนวน <span
                                class="text-red-500">*</span></label>
                        <input type="number" name="quantity" step="0.01" min="0.01" required
                            class="w-full text-3xl font-bold text-emerald-600 bg-emerald-50 border-2 border-emerald-100 rounded-2xl px-6 py-4 focus:ring-4 focus:ring-emerald-100 focus:border-emerald-500 text-center placeholder-emerald-200"
                            placeholder="0.00">
                    </div>

                    <!-- Reason/Note -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เหตุผล
                                (Reason)</label>
                            <select name="reason"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                                <option value="Stock In">รับเข้าสินค้าใหม่</option>
                                <option value="Return">รับคืนจากลูกค้า</option>
                                <option value="Damage">สินค้าเสียหาย</option>
                                <option value="Expired">สินค้าหมดอายุ</option>
                                <option value="Use">เบิกไปใช้</option>
                                <option value="Sell">ขาย (Bill/Order)</option>
                                <option value="Correction">ปรับปรุงยอด (Audit)</option>
                                <option value="Other">อื่นๆ</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">หมายเหตุ</label>
                            <input type="text" name="note"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>

                    <div class="pt-6">
                        <button type="submit"
                            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-lg font-bold py-4 rounded-2xl shadow-lg shadow-emerald-600/20 transition-all transform hover:-translate-y-1">
                            <i class="fas fa-save mr-2"></i> บันทึกรายการ
                        </button>
                    </div>
        </form>
    </div>
</div>

<script>
    const warehouseSelect = document.getElementById('warehouseSelect');
    const locationSelect = document.getElementById('locationSelect');

    warehouseSelect.addEventListener('change', async function () {
        const whId = this.value;
        locationSelect.innerHTML = '<option value="">-- กำลังโหลด... --</option>';
        locationSelect.disabled = true;

        if (!whId) {
            locationSelect.innerHTML = '<option value="">-- ไม่ระบุ / พื้นที่ทั่วไป --</option>';
            return;
        }

        try {
            const res = await fetch(`/api/inventory/warehouse/${whId}/locations`);
            const locs = await res.json();

            let html = '<option value="">-- ไม่ระบุ / พื้นที่ทั่วไป --</option>';
            locs.forEach(l => {
                html += `<option value="${l.id}">${l.name}</option>`;
            });
            locationSelect.innerHTML = html;
            locationSelect.disabled = false;
        } catch (e) {
            console.error(e);
            locationSelect.innerHTML = '<option value="">Error loading locations</option>';
        }
    });
</script>